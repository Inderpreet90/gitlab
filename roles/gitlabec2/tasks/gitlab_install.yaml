---
- name: Install GitLab Dependencies
  yum: state=present name={{ item }}
  with_items:
    - openssh-server
    - openssh-clients
    - curl
    - policycoreutils

- name: Download GitLab repository
  get_url: url=https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh dest=~

- name: Install repository 
  command: /bin/bash ~/script.rpm.sh 
       
- name: Install GitLab
  yum: name=gitlab-ce state=present

- name: Copy SSL certificate
  copy:
    src: roles/gitlabec2/files/selfsigned.pem
    dest: /etc/pki/tls/certs/selfsigned.pem

- name: Make changes in GitLab Config
  replace:
    dest: /etc/gitlab/gitlab.rb
    regexp: "^external_url.*"
    replace: "external_url 'https://{{ item.dns_name }}'"
  with_items:
    - "{{ ec2.instances }}"

- name: Fetch NFS instance facts
  ec2_remote_facts:
    region: "{{ aws_region }}"
    filters:
      "tag:Name": "{{ gitnfs_name }}"
  register: nfsec2

- name: Fetch the private ip of NFS instance
  set_fact:
    nfsip: "{{ item.private_ip_address }}"
  with_items:
    - "{{ nfsec2.instances }}"

- name: Add NFS endpoints in fstab
  lineinfile:
    dest: /etc/fstab
    line: "{{ nfsip }}:{{ item }}"
    state: present
  with_items:
    - "/var/opt/gitlab/git-data /var/opt/gitlab/git-data nfs4 defaults,soft,rsize=1048576,wsize=1048576,noatime,nobootwait,lookupcache=positive 0 2"

    - "/var/opt/gitlab/.ssh /var/opt/gitlab/.ssh nfs4 defaults,soft,rsize=1048576,wsize=1048576,noatime,nobootwait,lookupcache=positive 0 2"

    - "/var/opt/gitlab/gitlab-rails/uploads /var/opt/gitlab/gitlab-rails/uploads nfs4 defaults,soft,rsize=1048576,wsize=1048576,noatime,nobootwait,lookupcache=positive 0 2"

    - "/var/opt/gitlab/gitlab-rails/shared /var/opt/gitlab/gitlab-rails/shared nfs4 defaults,soft,rsize=1048576,wsize=1048576,noatime,nobootwait,lookupcache=positive 0 2"

    - "/var/opt/gitlab/gitlab-ci/builds /var/opt/gitlab/gitlab-ci/builds nfs4 defaults,soft,rsize=1048576,wsize=1048576,noatime,nobootwait,lookupcache=positive 0 2"

- name: Fetch RDS facts
  rds:
    region: "{{ aws_region }}"
    command: facts
    instance_name: "{{ rds_instance_name }}"
  register: rds_facts

- name: Get RDS endpoint
  set_fact:
    rdsendp: "{{ item.endpoint }}"
  with_items:
    - "{{ rds_facts.instance }}"

- name: Add some required config in gitlab config
  lineinfile:
    dest: /etc/gitlab/gitlab.rb
    line: "{{ item }}"
    state: present
  with_items:
    - nginx['redirect_http_to_https'] = true
    - nginx['ssl_certificate'] = "/etc/pki/tls/certs/selfsigned.pem"
    - nginx['ssl_certificate_key'] = "/etc/pki/tls/certs/selfsigned.pem"
    - gitlab_rails['db_adapter'] = "postgresql"
    - gitlab_rails['db_encoding'] = "unicode"    
    - gitlab_rails['db_database'] = "gitlabhq_production"   
    - gitlab_rails['db_username'] = "gitlab"
    - gitlab_rails['db_password'] = "securepass"
    - gitlab_rails['db_host'] = "{{ rdsendp }}"
    - gitlab_rails['redis_host'] = "redis-gitlab.5ini6h.0001.use1.cache.amazonaws.com"
    - gitlab_rails['redis_port'] = 6379

- name: Re-configure GitLab
  command: /usr/bin/gitlab-ctl reconfigure

- name: Install postgress extention required by Gitlab
  shell: export PGPASSWORD='securepass'; /opt/gitlab/embedded/bin/psql -U gitlab -h "{{ rdsendp }}" -d gitlabhq_production -c 'CREATE EXTENSION pg_trgm'
  ignore_errors: true

- name: Restart GitLab
  shell: gitlab-ctl restart

- name: Reboot instance
  ec2:
    region: "{{ aws_region }}"
    instance_tags:
      Name: "{{ Server_name }}"
    state: restarted

- name: Wait for Instance
  wait_for:
    host: "{{ item.public_ip }}"
    port: 22
    delay: 60
    timeout: 320
    state: started
  with_items: "{{ ec2.instances }}"


